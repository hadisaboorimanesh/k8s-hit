apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: monitoring
  name: querier
spec:
  replicas: {{ .Values.querier.replicas }}
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: querier
  template:
    metadata:
      labels:
        app.kubernetes.io/name: querier
    spec:
      serviceAccount: thanos
      securityContext:
        runAsUser: 1001
        fsGroup: 1001
      containers:
      - name: querier
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        args:
          - query
          - --log.level=debug
          - --endpoint.info-timeout=10m
          - --grpc-address=0.0.0.0:10901
          - --http-address=0.0.0.0:10902
          - --query.replica-label=prometheus_replica
          - --query.replica-label=receive_replica
          - --query.timeout=15m            
          - --store=dnssrv+_grpc._tcp.storegateway.monitoring.svc.cluster.local
          - --store=dnssrv+_grpc._tcp.thanos-receive-a.monitoring.svc.cluster.local
          - --store=dnssrv+_grpc._tcp.thanos-receive-b.monitoring.svc.cluster.local  

            #- --endpoint=dnssrv+_grpc._tcp.storegateway
            # - --endpoint=dnssrv+receiver-store-1:10907
            #- --endpoint=dnssrv+receiver-store-2:10907
#          - --endpoint=dnssrv+receiver-store-3:10907
#             - --endpoint=dnssrv+receiver-store-4:10907

        ports:
          - name: http
            containerPort: 10902
            protocol: TCP
          - name: grpc
            containerPort: 10901
            protocol: TCP
        livenessProbe:
          failureThreshold: 6
          httpGet:
            path: /-/healthy
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 30
        readinessProbe:
          failureThreshold: 6
          httpGet:
            path: /-/ready
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 30
        resources:
          requests:
            cpu: {{ .Values.querier.resources.requests.cpu }}
            memory: {{ .Values.querier.resources.requests.memory }}
          limits:
            cpu: {{ .Values.querier.resources.limits.cpu }}
            memory: {{ .Values.querier.resources.limits.memory }}
