global:
  scrape_interval: 20s
  evaluation_interval: 20s
  external_labels:
    cluster: $(CLUSTER_NAME)
    # Each Prometheus has to have unique labels.
    prometheus_replica: $(POD_NAME)

rule_files:
  - /etc/prometheus/rules/*rules.yaml

alerting:

  # We want our alerts to be deduplicated
  # from different replicas.
  alert_relabel_configs:
  - regex: prometheus_replica
    action: labeldrop

  alertmanagers:
    - scheme: http
      path_prefix: /
      static_configs:
        - targets: ['alertmanager:9093']

scrape_configs:
- job_name: 'windows-servers'
  static_configs:
    - targets: ['172.31.52.228:9182']
      labels:
        environment: 'sql-test'
    - targets: ['172.31.52.36:9182']
      labels:
        environment: 'sql-stage'
    - targets: ['172.31.52.2:9182']
      labels:
        environment: 'sql-azure'
    - targets: ['172.31.59.2:9182','172.31.59.3:9182']
      labels:
        environment: 'BI-Server'

- job_name: 'Minio-Client-Sync-to-Arvan'
  static_configs:
    - targets: ['minio.hasti.co:8595']
      labels:
        environment: 'Stage'

- job_name: 'linux-servers'
  static_configs:
    - targets: ['172.31.52.229:9182','172.31.52.226:9182','172.31.52.38:9182','172.31.52.39:9182','172.31.52.42:9182','172.31.52.227:9182','172.31.53.82:9182','172.31.52.41:9182','172.31.58.30:9182','172.31.58.232:9182','172.31.58.231:9182']
      
- job_name: minio-k8s
  bearer_token: eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJwcm9tZXRoZXVzIiwic3ViIjoiQk1KSjdsamhMM1dGM0J4TyIsImV4cCI6NDg1NTM3MzIxOX0.NPCrHrdqUumOW2gMZuzV3Hmvc1PRA65zrhIWredthIaArjnGfbNjR_TYPj7TKiV2YpDSfPd5jsoMEguShPod1A
  metrics_path: /minio/v2/metrics/cluster
  scheme: http
  static_configs:
    - targets: ['minio.minio.svc.cluster.local:9000']

- job_name: 'blackbox-http'
  scrape_interval: 30s
  metrics_path: /probe
  params:
    module: [http_2xx]  
  static_configs:
    - targets:
      #- https://api.kavenegar.com/v1/0/utils/getdate.json   
      - https://assets.dartil.com/index.html
      - https://dartil.com
      - https://admin.dartil.com
      - https://vendor.dartil.com
      - https://admingw.dartil.com
      - https://vendorgw.dartil.com
      - https://minio-admin.hasti.co
      - https://commercegw.dartil.com
      - https://qcommercegw.dartil.com
      - https://hasti.co
      - https://api.alopeyk.com/api/v2
      - https://sandbox-api.alopeyk.com/api/v2/  
      #- https://api.alopeyk.com/business-service
      # - https://map.ir/reverse?lat=54.318756103515625&lon=29.024248123168945  
      #- https://api.taroffexpress.com/api  
      #- https://api-zap.chabok.app/
      #- https://bpm.shaparak.ir
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115  

- job_name: 'blackbox-http-sandbox-alopeyk'
  scrape_interval: 60s
  metrics_path: /probe
  params:
    module: [http_sandbox_alopeyk]  
  static_configs:
    - targets:
      - https://sandbox-api.alopeyk.com/api/v2/
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115  


- job_name: 'blackbox-iplus-search'
  scrape_interval: 30s
  metrics_path: /probe
  params:
    module: [http_iplus_search]  
  static_configs:
    - targets:
      - https://api.iplussrv.com/search
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115  

- job_name: 'blackbox-iplus-autocomplete'
  scrape_interval: 30s
  metrics_path: /probe
  params:
    module: [http_iplus_autocomplete]  
  static_configs:
    - targets:
      - https://api.iplussrv.com/autocomplete
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115  

- job_name: 'blackbox-admingw'
  metrics_path: /probe
  params:
    module: [http_2xx]  
  static_configs:
    - targets:
      - https://admingw.dartil.com/integration/hc/live
      - https://admingw.dartil.com/admin/idr/hc/live
      - https://admingw.dartil.com/admin/notification/hc/live 
      - https://admingw.dartil.com/admin/locality/hc/live
      - https://admingw.dartil.com/admin/generaldata/hc/live
      - https://admingw.dartil.com/workflow/hc/live
      - https://admingw.dartil.com/admin/catalog/hc/live  
      - https://admingw.dartil.com/admin/cms/hc/live
      - https://admingw.dartil.com/admin/sale/hc/live
      - https://admingw.dartil.com/admin/report/hc/live
      - https://admingw.dartil.com/admin/payment/hc/live
      - https://admingw.dartil.com/admin/Social/hc/live
      - https://admingw.dartil.com/admin/crm/hc/live
      - https://admingw.dartil.com/admin/accounting/hc/live
      - https://admingw.dartil.com/admin/audit/hc/live
      - https://admingw.dartil.com/admin/wallet/hc/live
      - https://admingw.dartil.com/integration/hc/live
      - https://admingw.dartil.com/vas/hc/live
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115  # The blackbox exporter's real hostname:port.

- job_name: 'blackbox-commercegw'
  metrics_path: /probe
  params:
    module: [http_2xx]  
  static_configs:
    - targets:
      - https://commercegw.dartil.com/web/idr/hc/live
      - https://commercegw.dartil.com/web/locality/hc/live
      - https://commercegw.dartil.com/web/cms/hc/live
      - https://commercegw.dartil.com/web/generaldata/hc/live
      - https://commercegw.dartil.com/web/cms/hc/live
      - https://commercegw.dartil.com/web/sale/hc/live
      - https://commercegw.dartil.com/web/payment/hc/live
      - https://commercegw.dartil.com/web/social/hc/live
      - https://commercegw.dartil.com/web/crm/hc/live
      - https://commercegw.dartil.com/web/wallet/hc/live
      
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115  # The blackbox exporter's real hostname:port.

- job_name: 'blackbox-vendorgw'
  metrics_path: /probe
  params:
    module: [http_2xx]  
  static_configs:
    - targets:
      - https://vendorgw.dartil.com/web/idr/hc/live
      - https://vendorgw.dartil.com/web/locality/hc/live
      - https://vendorgw.dartil.com/web/catalog/hc/live
      - https://vendorgw.dartil.com/web/generaldata/hc/live
      - https://vendorgw.dartil.com/web/cms/hc/live
      - https://vendorgw.dartil.com/web/sale/hc/live
      - https://vendorgw.dartil.com/web/payment/hc/live
      - https://vendorgw.dartil.com/web/social/hc/live
      - https://vendorgw.dartil.com/web/crm/hc/live
      - https://vendorgw.dartil.com/web/wallet/hc/live
      - https://vendorgw.dartil.com/web/Accounting/hc/live
      - https://vendorgw.dartil.com/web/workflow/hc/live
      - https://vendorgw.dartil.com/web/hub/hc/live
      
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115  # The blackbox exporter's real hostname:port.

- job_name: 'blackbox-icmp'
  metrics_path: /probe
  params:
    module: [icmp]  
  static_configs:
    - targets:
      - 172.31.52.228
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115  # The blackbox exporter's real hostname:port.

- job_name: 'blackbox-tcp'
  metrics_path: /probe
  params:
    module: [tcp_connect]  
  static_configs:
    - targets:
      - 172.31.52.228:9182 
  relabel_configs:
    - source_labels: [__address__]
      target_label: __param_target
    - source_labels: [__param_target]
      target_label: instance
    - target_label: __address__
      replacement: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115  # The blackbox exporter's real hostname:port.

- job_name: 'blackbox_exporter'  
  static_configs:
    - targets: ['blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115']

- job_name: kubernetes-nodes-cadvisor
  scrape_interval: 10s
  scrape_timeout: 10s
  scheme: https
  tls_config:
    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  kubernetes_sd_configs:
    - role: node
  relabel_configs:
    - action: labelmap
      regex: __meta_kubernetes_node_label_(.+)
    # Only for Kubernetes ^1.7.3.
    # See: https://github.com/prometheus/prometheus/issues/2916
    - target_label: __address__
      replacement: kubernetes.default.svc:443
    - source_labels: [__meta_kubernetes_node_name]
      regex: (.+)
      target_label: __metrics_path__
      replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
  metric_relabel_configs:
    - action: replace
      source_labels: [id]
      regex: '^/machine\.slice/machine-rkt\\x2d([^\\]+)\\.+/([^/]+)\.service$'
      target_label: rkt_container_name
      replacement: '${2}-${1}'
    - action: replace
      source_labels: [id]
      regex: '^/system\.slice/(.+)\.service$'
      target_label: systemd_service_name
      replacement: '${1}'

- job_name: kubernetes-nodes-kubelet
  scrape_interval: 10s
  scrape_timeout: 10s
  scheme: https
  tls_config:
    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  kubernetes_sd_configs:
    - role: node
  relabel_configs:
    - action: labelmap
      regex: __meta_kubernetes_node_label_(.+)
    # Only for Kubernetes ^1.7.3.
    # See: https://github.com/prometheus/prometheus/issues/2916
    - target_label: __address__
      replacement: kubernetes.default.svc:443
    - source_labels: [__meta_kubernetes_node_name]
      regex: (.+)
      target_label: __metrics_path__
      replacement: /api/v1/nodes/${1}/proxy/metrics
  metric_relabel_configs:
    - action: replace
      source_labels: [id]
      regex: '^/machine\.slice/machine-rkt\\x2d([^\\]+)\\.+/([^/]+)\.service$'
      target_label: rkt_container_name
      replacement: '${2}-${1}'
    - action: replace
      source_labels: [id]
      regex: '^/system\.slice/(.+)\.service$'
      target_label: systemd_service_name
      replacement: '${1}'

- job_name: 'kubernetes-pods'
  kubernetes_sd_configs:
    - role: pod
  relabel_configs:
    - action: labelmap
      regex: __meta_kubernetes_pod_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_pod_name]
      action: replace
      target_label: kubernetes_pod_name
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]
      action: replace
      target_label: __scheme__
      regex: (https?)
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
      action: replace
      target_label: __address__
      regex: ([^:]+)(?::\d+)?;(\d+)
      replacement: $1:$2

- job_name: 'kubernetes-apiservers'
  kubernetes_sd_configs:
    - role: endpoints
  scheme: https 
  tls_config:
    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
  relabel_configs:
    - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
      action: keep
      regex: default;kubernetes;https

- job_name: 'kubernetes-service-endpoints'
  scrape_interval: 10s
  scrape_timeout: 10s
  kubernetes_sd_configs:
    - role: endpoints
  relabel_configs:
    - action: labelmap
      regex: __meta_kubernetes_service_label_(.+)
    - source_labels: [__meta_kubernetes_namespace]
      action: replace
      target_label: kubernetes_namespace
    - source_labels: [__meta_kubernetes_service_name]
      action: replace
      target_label: kubernetes_name
    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
      action: keep
      regex: true
    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
      action: replace
      target_label: __scheme__
      regex: (https?)
    - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
      action: replace
      target_label: __metrics_path__
      regex: (.+)
    - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
      action: replace
      target_label: __address__
      regex: (.+)(?::\d+);(\d+)
      replacement: $1:$2
